<!doctype html>
<html lang="sv">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Västsvensk domarstatistik</title>

<style>
  :root{
    --bg:#f7f9fc; --card:#ffffff; --text:#0f172a; --muted:#6b7280; --border:#e6e9f2;
    --accent:#6d28d9;
    --accent-2:#9333ea;
    --accent-weak:#ede9fe;
  }

  .disclaimer{
    margin:18px 4px 8px;
    font-size:11px;
    line-height:1.5;
    color:var(--muted);
    text-align:center;
  }
  .disclaimer a{
    color:var(--accent);
    text-decoration:none;
  }
  .disclaimer a:hover{
    text-decoration:underline;
  }

  *{box-sizing:border-box}
  body{
    margin:14px;
    font:15px/1.55 Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial;
    color:var(--text); background:var(--bg);
  }
  .wrap{max-width:1100px;margin:auto}

  h1{
    font-size:30px;margin:14px 0 18px;text-align:center;font-weight:900;letter-spacing:.4px;
    background:linear-gradient(90deg,var(--accent),var(--accent-2));
    -webkit-background-clip:text;background-clip:text;color:transparent;
  }

  .row{display:grid;gap:12px;grid-template-columns:1fr;margin:10px 0}
  @media(min-width:820px){
    .row.filters{grid-template-columns:repeat(4,minmax(0,1fr));}
    .row.stats-row{grid-template-columns:repeat(3,minmax(0,1fr));} /* 3 kort i stats-raden */
  }

  .card{
    background:var(--card);border:1px solid var(--border);border-radius:16px;padding:14px 16px;
    box-shadow:0 4px 10px rgba(0,0,0,.04),0 8px 24px rgba(0,0,0,.04);
  }
  .muted{color:var(--muted);font-size:12px;margin-bottom:6px}

  .ref-select{
    width:100%;
    padding:6px 0;
    border:none;
    background:transparent;
    color:var(--text);
    font-size:18px;
    font-weight:800;
    outline:none;
  }

  .clear-btn{
    width:100%;
    padding:10px 12px;
    border-radius:999px;
    border:1px solid var(--border);
    background:#f3e8ff; /* fallback */
    background:color-mix(in oklab,var(--accent-weak) 60%, var(--card));
    color:var(--accent);
    font-weight:700;
    font-size:14px;
    cursor:pointer;
    transition:background .15s, box-shadow .15s, transform .05s;
  }
  .clear-btn:hover{
    background:#ede9ff; /* fallback */
    background:color-mix(in oklab,var(--accent-weak) 80%, var(--card));
    box-shadow:0 3px 10px rgba(0,0,0,.06);
  }
  .clear-btn:active{ transform:translateY(1px); }

  .table-wrap{ width:100%; overflow-x:hidden; }
  table{
    width:100%;
    border-collapse:collapse;background:var(--card);
    border:1px solid var(--border);border-radius:16px;overflow:hidden;
    table-layout:auto;
  }
  thead{
    background:#f3f4ff; /* fallback */
    background:color-mix(in oklab,var(--accent-weak) 30%, var(--card));
    color:var(--accent);
  }
  th,td{padding:11px 12px;border-bottom:1px solid var(--border);text-align:left}
  th{font-weight:800;text-transform:uppercase;letter-spacing:.3px}
  th:first-child, td:first-child{white-space:nowrap;width:120px;}

  @media (min-width:601px){
    tbody tr:hover{
      background:#f3f4ff;
      background:color-mix(in oklab,var(--accent-weak) 40%, var(--card));
    }
  }

  .list{
    max-height:420px;overflow:auto;border:1px solid var(--border);
    border-radius:16px;background:var(--card);
    -webkit-overflow-scrolling:touch;
  }
  .item{
    display:flex;justify-content:space-between;align-items:center;
    padding:13px 14px;border-bottom:1px solid var(--border);cursor:pointer;
    transition:background .15s, transform .05s;
  }
  .item:hover{
    background:#f3f4ff;
    background:color-mix(in oklab,var(--accent-weak) 40%, var(--card))
  }
  .item:active{transform:translateY(1px)}
  .item.active{
    background:#ede9ff;
    background:color-mix(in oklab,var(--accent-weak) 60%, var(--card));
    font-weight:600
  }
  .pill{
    display:inline-flex;align-items:center;gap:6px;font:600 12px/1 Inter,system-ui;
    padding:3px 10px;border-radius:999px;
    background:#f6f0ff;
    background:color-mix(in oklab,var(--accent) 10%, var(--card));
    color:var(--accent);
    border:1px solid #e0d4ff;
    border-color:color-mix(in oklab,var(--accent) 25%, var(--border));
  }

  .mini-list{
    display:flex;
    flex-direction:column;
    gap:4px;
    font-size:14px;
  }
  .mini-item{
    display:flex;
    align-items:center;
    gap:6px;
    padding:4px 0;
    border-bottom:1px dashed var(--border);
  }
  .mini-item:last-child{
    border-bottom:none;
  }
  .mini-rank{
    font-weight:700;
    color:var(--accent);
    width:20px;
  }
  .mini-name{
    flex:1;
    overflow:hidden;
    text-overflow:ellipsis;
    white-space:nowrap;
  }
  .mini-count{
    font-variant-numeric:tabular-nums;
    font-weight:600;
    min-width:20px;
    text-align:right;
  }

  @media (max-width:600px){
    body{ margin:8px; font-size:14px; }
    h1{ font-size:24px; margin:10px 0 14px; }
    .card{ padding:10px 12px; border-radius:14px; box-shadow:0 2px 8px rgba(0,0,0,.05); }
    .list{ max-height:320px; }
    th,td{ font-size:13px; padding:8px 8px; }
    .ref-select{ font-size:16px; }

    .table-wrap table{ border:none; }
    thead{ display:none; }

    tbody tr{
      display:block;
      background:var(--card);
      margin-bottom:14px;
      border-radius:14px;
      padding:10px 12px;
      box-shadow:0 3px 10px rgba(0,0,0,.08);
      border:1px solid var(--border);
    }

    tbody td{
      display:flex;
      justify-content:space-between;
      padding:6px 4px;
      border-bottom:none;
      word-break:break-word;
    }

    td[data-label="Datum"]{
      font-weight:700;
      font-size:14px;
      padding-bottom:10px;
      margin-bottom:6px;
      border-bottom:1px solid var(--border);
    }
    td[data-label="Datum"]::before{
      content:"Datum";
      font-weight:700;
      color:var(--accent);
      margin-right:10px;
    }

    td:not([data-label="Datum"])::before{
      content:attr(data-label);
      font-weight:600;
      color:var(--muted);
      margin-right:10px;
    }
  }
</style>

<div class="wrap">
  <h1>VÄSTSVENSK DOMARSTATISTIK</h1>

  <div class="row filters" id="filters">
    <div class="card">
      <div id="seasonLabel" class="muted">Säsong</div>
      <select id="seasonSelect" class="ref-select">
        <option value="">(alla säsonger)</option>
      </select>
    </div>
    <div class="card">
      <div class="muted">Serie</div>
      <select id="seriesSelect" class="ref-select">
        <option value="">(alla serier)</option>
      </select>
    </div>
    <div class="card">
      <div class="muted">Domare</div>
      <select id="refSelect" class="ref-select">
        <option value="">(alla domare)</option>
      </select>
    </div>
    <div class="card">
      <div class="muted">Rensa filter</div>
      <button id="clearBtn" class="clear-btn">Rensa</button>
    </div>
  </div>

  <div class="row">
    <div class="card">
      <div class="muted">Antal matcher per domare (baserat på valda filter)</div>
      <div id="toplist" class="list">Laddar…</div>
    </div>
  </div>

  <div class="row stats-row">
    <div class="card">
      <div class="muted">Antal matcher per säsong för vald domare (topp 3)</div>
      <div id="topSeasons" class="mini-list">
        <span class="muted">Välj domare i listan eller i menyn</span>
      </div>
    </div>

    <div class="card">
      <div class="muted">Antal matcher per serie för vald domare (topp 3)</div>
      <div id="topSeries" class="mini-list">
        <span class="muted">Välj domare i listan eller i menyn</span>
      </div>
    </div>

    <div class="card">
      <div class="muted">Antal matcher per domarkollega för vald domare (topp 3)</div>
      <div id="topColleagues" class="mini-list">
        <span class="muted">Välj domare i listan eller i menyn</span>
      </div>
    </div>
  </div>

  <div class="row">
    <div class="card" style="grid-column:1;">
      <div class="muted">Matchlista för vald domare (baserat på valda filter)</div>
      <div class="table-wrap">
        <table>
          <thead><tr>
            <th>Datum</th><th>Serie</th><th>Hemmalag</th><th>Bortalag</th><th>Arena</th><th>Domarkollega</th>
          </tr></thead>
          <tbody id="rows">
            <tr><td colspan="6" class="muted">Välj domare i listan eller i menyn</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <div class="disclaimer">
    Inofficiell sida baserad på öppna uppgifter från
    <a href="https://stats.innebandy.se" target="_blank">stats.innebandy.se</a>
    <br>Kontakt <a href="mailto:refstat@dzanic.se">refstat@dzanic.se</a>
  </div>
</div>

<script>
(function(){
  const CACHE_KEY = "refstat_domarstat_v1";

  function parseCSV(s){
    const out=[], re=/\s*(?:"([^"]*(?:""[^"]*)*)"|([^,"\r\n]*))\s*(,|\r?\n|$)/g;
    let m,row=[],head;
    const val=(a,b)=>(a||b||"").replace(/""/g,'"');
    while((m=re.exec(s))){
      row.push(val(m[1],m[2]));
      if(m[3]!==','){
        out.push(row); row=[];
        if(!m[3]) break;
      }
    }
    head=out.shift()||[];
    return out.map(r=>Object.fromEntries(head.map((h,i)=>[h.trim(),(r[i]??"").trim()])));
  }

  function norm(rec){
    const g=k=>rec[k]??""; const first=x=>(x||"").split(/[ T]/)[0];
    const refs=(g("Referees")||g("Domare")||g("DomareLista")||"") ||
               [g("Domare1"),g("Domare2"),g("Domare3"),
                g("Referee1"),g("Referee2"),g("Referee3")]
               .filter(Boolean).join(",");
    const date = first(g("Date")||g("Datum")||g("MatchDate")||g("Start")||g("Kickoff"));
    return {
      date,
      series:g("Serie")||g("Series")||g("Competition")||"",
      arena:g("Arena")||g("Venue")||g("Hall")||"",
      home:g("Hemmalag")||g("Home")||g("HomeTeam")||g("Hemma")||"",
      away:g("Bortalag")||g("Away")||g("AwayTeam")||g("Borta")||"",
      referees:refs.split(/[;,|]/).map(s=>s.trim()).filter(Boolean)
    };
  }

  function createParserWorker(){
    const workerSource = `
      self.onmessage = function(e){
        const texts = e.data.texts || [];
        function parseCSV(s){
          const out=[], re=/\\s*(?:"([^"]*(?:""[^"]*)*)"|([^,"\\r\\n]*))\\s*(,|\\r?\\n|$)/g;
          let m,row=[],head;
          const val=(a,b)=>(a||b||"").replace(/""/g,'"');
          while((m=re.exec(s))){
            row.push(val(m[1],m[2]));
            if(m[3]!==','){
              out.push(row); row=[];
              if(!m[3]) break;
            }
          }
          head=out.shift()||[];
          return out.map(r=>Object.fromEntries(head.map((h,i)=>[h.trim(),(r[i]??"").trim()])));
        }
        function norm(rec){
          const g=k=>rec[k]??""; const first=x=>(x||"").split(/[ T]/)[0];
          const refs=(g("Referees")||g("Domare")||g("DomareLista")||"") ||
                     [g("Domare1"),g("Domare2"),g("Domare3"),
                      g("Referee1"),g("Referee2"),g("Referee3")]
                     .filter(Boolean).join(",");
          const date = first(g("Date")||g("Datum")||g("MatchDate")||g("Start")||g("Kickoff"));
          return {
            date,
            series:g("Serie")||g("Series")||g("Competition")||"",
            arena:g("Arena")||g("Venue")||g("Hall")||"",
            home:g("Hemmalag")||g("Home")||g("HomeTeam")||g("Hemma")||"",
            away:g("Bortalag")||g("Away")||g("AwayTeam")||g("Borta")||"",
            referees:refs.split(/[;,|]/).map(s=>s.trim()).filter(Boolean)
          };
        }
        const all=[];
        for(const t of texts){
          const rows = parseCSV(t).map(norm);
          for(const r of rows){
            if(r.date) all.push(r);
          }
        }
        self.postMessage({all});
      };
    `;
    const blob = new Blob([workerSource], {type:"application/javascript"});
    const url  = URL.createObjectURL(blob);
    return new Worker(url);
  }

  function initDomarstat(all){
    const $seasonSelect   = document.getElementById("seasonSelect");
    const $refSelect      = document.getElementById("refSelect");
    const $seriesSelect   = document.getElementById("seriesSelect");
    const $rows           = document.getElementById("rows");
    const $top            = document.getElementById("toplist");
    const $clearBtn       = document.getElementById("clearBtn");
    const $topSeries      = document.getElementById("topSeries");
    const $topSeasons     = document.getElementById("topSeasons");
    const $topColleagues  = document.getElementById("topColleagues");
    const $seasonLabel    = document.getElementById("seasonLabel");

    let currentSeason = "";
    let currentRef    = "";
    let currentSeries = "";

    const allDates = all.map(m => m.date).filter(Boolean).sort();
    if($seasonLabel && allDates.length){
      const minDate = allDates[0];
      const maxDate = allDates[allDates.length - 1];
      $seasonLabel.textContent = `Säsong (inom ${minDate} - ${maxDate})`;
    }

    function seasonLabelFromDate(d){
      if(!d) return "";
      const year = parseInt(d.slice(0,4),10);
      const md   = d.slice(5);
      const startYear = (md >= "07-01") ? year : year - 1;
      const nextYear  = startYear + 1;
      return startYear + "/" + String(nextYear).slice(-2);
    }

    const seasons = new Map();
    for(const m of all){
      const label = seasonLabelFromDate(m.date);
      if(!label) continue;
      const startYear = parseInt(label.slice(0,4),10);
      const nextYear  = startYear + 1;
      if(!seasons.has(label)){
        seasons.set(label,{
          start: startYear + "-07-01",
          end:   nextYear  + "-06-30"
        });
      }
    }

    const seasonLabels = [...seasons.keys()]
      .sort((a,b)=>seasons.get(b).start.localeCompare(seasons.get(a).start));

    function updateSeasonOptions(){
      const set = new Set();
      for(const m of all){
        if(currentSeries && m.series !== currentSeries) continue;
        if(currentRef && !m.referees.includes(currentRef)) continue;
        const label = seasonLabelFromDate(m.date);
        if(label) set.add(label);
      }
      const prev = currentSeason;
      const arr = seasonLabels.filter(s => set.size === 0 || set.has(s));

      $seasonSelect.innerHTML =
        '<option value="">(alla säsonger)</option>' +
        arr.map(s => `<option value="${s}">${s}</option>`).join("");

      if(prev && set.has(prev)){
        currentSeason = prev;
        $seasonSelect.value = prev;
      }else{
        currentSeason = "";
        $seasonSelect.value = "";
      }
    }

    updateSeasonOptions();

    function inCurrentSeason(date){
      if(!currentSeason) return true;
      const s = seasons.get(currentSeason);
      if(!s) return true;
      return (!s.start || date >= s.start) && (!s.end || date <= s.end);
    }

    function updateRefOptions(){
      const set = new Set();
      for(const m of all){
        if(!inCurrentSeason(m.date)) continue;
        if(currentSeries && m.series !== currentSeries) continue;
        for(const r of m.referees) set.add(r);
      }
      const prev = currentRef;
      const arr = [...set].sort((a,b)=>a.localeCompare(b,"sv"));
      $refSelect.innerHTML =
        '<option value="">(alla domare)</option>' +
        arr.map(n => `<option value="${n}">${n}</option>`).join("");

      if(prev && set.has(prev)){
        currentRef = prev;
        $refSelect.value = prev;
      }else{
        currentRef = "";
        $refSelect.value = "";
      }
    }

    function updateSeriesOptions(){
      const set = new Set();
      for(const m of all){
        if(!inCurrentSeason(m.date)) continue;
        if(currentRef && !m.referees.includes(currentRef)) continue;
        if(m.series) set.add(m.series);
      }
      const prev = currentSeries;
      const arr = [...set].sort((a,b)=>a.localeCompare(b,"sv"));
      $seriesSelect.innerHTML =
        '<option value="">(alla serier)</option>' +
        arr.map(s => `<option value="${s}">${s}</option>`).join("");

      if(prev && set.has(prev)){
        currentSeries = prev;
        $seriesSelect.value = prev;
      }else{
        currentSeries = "";
        $seriesSelect.value = "";
      }
    }

    function renderTop(){
      const cnt = new Map();
      for(const m of all){
        if(!inCurrentSeason(m.date)) continue;
        if(currentSeries && m.series !== currentSeries) continue;
        for(const r of m.referees){
          cnt.set(r,(cnt.get(r)||0)+1);
        }
      }
      const arr = [...cnt.entries()].sort((a,b)=>b[1]-a[1]);
      if(!arr.length){
        $top.textContent = "Inga matcher i vald filtrering.";
        return;
      }
      $top.innerHTML = arr.map(([name,n]) => `
        <div class="item" data-ref="${name}">
          <span>${name}</span><span class="pill">${n}</span>
        </div>
      `).join("");

      const items = $top.querySelectorAll(".item");
      items.forEach(el=>{
        if(el.dataset.ref === currentRef) el.classList.add("active");
        el.onclick = ()=>{
          currentRef = el.dataset.ref;
          $refSelect.value = currentRef;
          updateSeasonOptions();
          updateSeriesOptions();
          renderTop();
          renderMatches();
          const active = $top.querySelector(`.item[data-ref="${currentRef}"]`);
          if(active) active.scrollIntoView({behavior:"smooth", block:"center"});
        };
      });
    }

    function renderTopMiniLists(rows){
      if(!currentRef){
        $topSeries.innerHTML     = '<span class="muted"></span>';
        $topColleagues.innerHTML = '<span class="muted"></span>';
        return;
      }
      if(!rows.length){
        $topSeries.innerHTML     = '<span class="muted">Ingen seriestatistik för valda filter.</span>';
        $topColleagues.innerHTML = '<span class="muted">Ingen kollegestatistik för valda filter.</span>';
        return;
      }

      const seriesCount    = new Map();
      const colleagueCount = new Map();

      for(const m of rows){
        if(m.series){
          seriesCount.set(m.series,(seriesCount.get(m.series)||0)+1);
        }
        const others = (m.referees||[]).filter(r=>r!==currentRef);
        for(const col of others){
          colleagueCount.set(col,(colleagueCount.get(col)||0)+1);
        }
      }

      function renderMap(map, container, emptyText){
        const arr = [...map.entries()].sort((a,b)=>b[1]-a[1]).slice(0,3);
        if(!arr.length){
          container.innerHTML = `<span class="muted">${emptyText}</span>`;
          return;
        }
        container.innerHTML = arr.map(([name,n],idx)=>`
          <div class="mini-item">
            <span class="mini-rank">${idx+1}.</span>
            <span class="mini-name">${name}</span>
            <span class="mini-count">${n}</span>
          </div>
        `).join("");
      }

      renderMap(seriesCount,    $topSeries,     "Ingen seriestatistik.");
      renderMap(colleagueCount, $topColleagues, "Ingen kollegestatistik.");
    }

    function renderTopSeasons(rows){
      if(!currentRef){
        $topSeasons.innerHTML = '<span class="muted"></span>';
        return;
      }
      if(!rows.length){
        $topSeasons.innerHTML = '<span class="muted">Ingen säsongsstatistik för valda filter.</span>';
        return;
      }

      const seasonCount = new Map();
      for(const m of rows){
        const label = seasonLabelFromDate(m.date);
        if(!label) continue;
        seasonCount.set(label,(seasonCount.get(label)||0)+1);
      }

      const arr = [...seasonCount.entries()].sort((a,b)=>{
        // sortera efter säsongens startdatum med seasons-map om möjligt
        const sa = seasons.get(a[0]);
        const sb = seasons.get(b[0]);
        const ka = sa ? sa.start : a[0];
        const kb = sb ? sb.start : b[0];
        // flest matcher först, vid lika: nyare säsong först
        const diff = b[1]-a[1];
        if(diff !== 0) return diff;
        return kb.localeCompare(ka);
      }).slice(0,3);

      if(!arr.length){
        $topSeasons.innerHTML = '<span class="muted">Ingen säsongsstatistik.</span>';
        return;
      }

      $topSeasons.innerHTML = arr.map(([season,n],idx)=>`
        <div class="mini-item">
          <span class="mini-rank">${idx+1}.</span>
          <span class="mini-name">${season}</span>
          <span class="mini-count">${n}</span>
        </div>
      `).join("");
    }

    function renderMatches(){
      const rows = all
        .filter(m =>
          inCurrentSeason(m.date) &&
          (!currentRef || m.referees.includes(currentRef)) &&
          (!currentSeries || m.series === currentSeries)
        )
        .sort((a,b)=>(b.date||"").localeCompare(a.date||""));

      renderTopMiniLists(rows);
      renderTopSeasons(rows);

      if(!currentRef){
        $rows.innerHTML = '<tr><td colspan="6" class="muted">Välj domare i listan eller i menyn</td></tr>';
      }else if(!rows.length){
        $rows.innerHTML = `<tr><td colspan="6" class="muted">Inga matcher för ${currentRef} i vald filtrering.</td></tr>`;
      }else{
        $rows.innerHTML = rows.map(m=>{
          const others = (m.referees||[]).filter(r=>r!==currentRef);
          return (
            '<tr>' +
              `<td data-label="Datum">${m.date}</td>` +
              `<td data-label="Serie">${m.series}</td>` +
              `<td data-label="Hemmalag">${m.home}</td>` +
              `<td data-label="Bortalag">${m.away}</td>` +
              `<td data-label="Arena">${m.arena}</td>` +
              `<td data-label="Domarkollega">${(others.join(", ")||"—")}</td>` +
            '</tr>'
          );
        }).join("");
      }
    }

    $seasonSelect.addEventListener("change", ()=>{
      currentSeason = $seasonSelect.value || "";
      updateRefOptions();
      updateSeriesOptions();
      renderTop();
      renderMatches();
      if(currentRef){
        const active = $top.querySelector(`.item[data-ref="${currentRef}"]`);
        if(active) active.scrollIntoView({behavior:"smooth", block:"center"});
      }else{
        $top.scrollTop = 0;
      }
    });

    $seriesSelect.addEventListener("change", ()=>{
      currentSeries = $seriesSelect.value || "";
      updateSeasonOptions();
      updateRefOptions();
      renderTop();
      renderMatches();
      if(currentRef){
        const active = $top.querySelector(`.item[data-ref="${currentRef}"]`);
        if(active) active.scrollIntoView({behavior:"smooth", block:"center"});
      }else{
        $top.scrollTop = 0;
      }
    });

    $refSelect.addEventListener("change", ()=>{
      currentRef = $refSelect.value || "";
      updateSeasonOptions();
      updateSeriesOptions();
      renderTop();
      renderMatches();
      const active = $top.querySelector(`.item[data-ref="${currentRef}"]`);
      if(active) active.scrollIntoView({behavior:"smooth", block:"center"});
    });

    $clearBtn.addEventListener("click", ()=>{
      currentSeason = "";
      currentRef    = "";
      currentSeries = "";
      $seasonSelect.value = "";
      $refSelect.value    = "";
      $seriesSelect.value = "";
      updateSeasonOptions();
      updateRefOptions();
      updateSeriesOptions();
      renderTop();
      renderMatches();
      $top.scrollTop = 0;
    });

    updateRefOptions();
    updateSeriesOptions();
    renderTop();
    renderMatches();
  }

  (async function load(){
    try{
      const cached = sessionStorage.getItem(CACHE_KEY);
      if(cached){
        const all = JSON.parse(cached);
        if(Array.isArray(all) && all.length){
          initDomarstat(all);
          return;
        }
      }
    }catch(e){
      console.warn("sessionStorage otillgänglig/korrupt", e);
    }

    const filesResp = await fetch("csv/files.json");
    const files = await filesResp.json();
    const texts = await Promise.all(files.map(f => fetch("csv/" + f).then(r => r.text())));

    if(window.Worker){
      const worker = createParserWorker();
      worker.onmessage = function(e){
        const all = e.data.all || [];
        try{
          sessionStorage.setItem(CACHE_KEY, JSON.stringify(all));
        }catch(err){
          console.warn("Kunde inte skriva cache till sessionStorage", err);
        }
        initDomarstat(all);
        worker.terminate();
      };
      worker.postMessage({texts});
    }else{
      const all = texts.flatMap(t => parseCSV(t).map(norm)).filter(r=>r.date);
      try{
        sessionStorage.setItem(CACHE_KEY, JSON.stringify(all));
      }catch(err){
        console.warn("Kunde inte skriva cache till sessionStorage", err);
      }
      initDomarstat(all);
    }
  })().catch(err=>{
    console.error("Fel vid laddning av data", err);
  });
})();
</script>
</html>
