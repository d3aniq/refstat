<!doctype html>
<html lang="sv">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">

<title>DʒaniQ RefStat – Domarstatistik</title>
<script src="https://cdn.tailwindcss.com"></script>

<style>
  body { font-family: system-ui, sans-serif; }
</style>
</head>

<body class="bg-gray-100 min-h-screen">

<!-- HEADER -->
<header class="bg-indigo-600 text-white p-4 shadow">
  <h1 class="text-xl font-semibold text-center">NATIONELL DOMARSTATISTIK</h1>
</header>

<!-- PROGRESS BAR -->
<div id="loadingBarContainer" class="hidden p-4">
  <div class="mb-1 text-sm text-gray-600">Hämtar matcher...</div>
  <div class="w-full bg-gray-300 rounded h-3">
    <div id="loadingBar" class="bg-indigo-600 h-3 rounded transition-all"></div>
  </div>
</div>

<!-- DATE + FEDERATION PANEL -->
<div class="p-4 space-y-4">



  <!-- Hårdkodade förbund -->
  <div>
    <label class="block font-medium text-sm">Förbund</label>
    <select id="federationSelect" class="w-full p-2 border rounded mt-1">
      <!-- <option value="">Välj förbund...</option> -->

      <!-- Nationella -->

      

      <!-- Distrikt – alfabetiskt -->
      <option value="21">Västsvenska IBF</option>
      <option value="1">Svenska IBF</option>
      <option value="3">Blekinge IBF</option>
      <option value="13">Bohuslän-Dals IBF</option>
      <option value="18">Dalarnas IBF</option>
      <option value="19">Gotlands IBF</option>
      <option value="20">Gävleborgs IBF</option>
      <option value="22">Hallands IBF</option>
      <option value="23">Hälsinglands IBF</option>
      <option value="24">Jämtland/Härjedalens IBF</option>
      <option value="4">Norrbottens IBF</option>
      <option value="44">Parasport</option>
      <option value="6">Skånes IBF</option>
      <option value="7">Småland Blekinges IBF</option>
      <option value="8">Stockholms IBF</option>
      <option value="9">Södermanlands IBF</option>
      <option value="10">Upplands IBF</option>
      <option value="11">Värmlands IBF</option>
      <option value="12">Västerbottens IBF</option>
      <option value="14">Västergötlands IBF</option>
      <option value="17">Västernorrlands IBF</option>
      <option value="15">Västmanlands IBF</option>
      <option value="5">Örebro Läns IBF</option>
      <option value="16">Östergötlands IBF</option>
    </select>
  </div>

    <!-- Datum -->
  <div>
    <label class="block font-medium text-sm">Datumintervall</label>
    <div class="flex gap-2 mt-1">
      <input id="fromDate" type="date" class="flex-1 p-2 border rounded">
      <input id="toDate" type="date" class="flex-1 p-2 border rounded">
    </div>
  </div>

  <button id="loadBtn"
          class="w-full bg-indigo-600 text-white p-2 rounded shadow active:scale-[.98]">
    Ladda
  </button>
</div>

<!-- TOPLIST -->
<div id="toplist" class="p-4 space-y-3"></div>

<!-- FILTER PANEL -->
<div class="p-4">
  <label class="block mb-1 font-medium text-sm">Filtrera på domare</label>
  <select id="refereeFilter" class="w-full p-2 border rounded">
    <option value="">Välj domare...</option>
  </select>
</div>

<!-- MATCH LIST -->
<div id="content" class="p-4 space-y-4">
  <div class="text-center text-gray-500">Välj datum och klicka på "Ladda".</div>
</div>


<script>
const WORKER_BASE_URL = "https://refstat-test.jasmin-e21.workers.dev/?";
let allMatches = [];

/* ==========================================================================
   PROGRESS BAR
   ========================================================================== */
function showProgressBar() {
  document.getElementById("loadingBarContainer").classList.remove("hidden");
  document.getElementById("loadingBar").style.width = "0%";
}
function updateProgressBar(percent) {
  document.getElementById("loadingBar").style.width = percent + "%";
}
function hideProgressBar() {
  document.getElementById("loadingBarContainer").classList.add("hidden");
}

/* ==========================================================================
   LOAD MATCHES
   ========================================================================== */
async function loadRange() {
  const from = document.getElementById("fromDate").value;
  const to   = document.getElementById("toDate").value;
  const fed  = document.getElementById("federationSelect").value;

  if (!from || !to || !fed) {
    alert("Fyll i både datum och förbund.");
    return;
  }

  const start = new Date(from);
  const end   = new Date(to);
  const totalDays = Math.ceil((end - start) / 86400000) + 1;
  let currentDay = 0;

  showProgressBar();
  allMatches = [];

  for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
    const iso = d.toISOString().slice(0, 10);
    const url = `${WORKER_BASE_URL}date=${iso}&fed=${fed}`;

    try {
      const res = await fetch(url);
      const data = await res.json();

      data.forEach(comp => {
        comp.Matches.forEach(m => {
          allMatches.push({ ...m, competitionName: comp.Name });
        });
      });

    } catch (err) {
      console.error("Fel vid laddning:", iso, err);
    }

    currentDay++;
    updateProgressBar(Math.round((currentDay / totalDays) * 100));
  }

  hideProgressBar();
  buildToplist(allMatches);
  populateRefereeFilter(allMatches);

  document.getElementById("content").innerHTML =
    `<div class="text-center text-gray-500">Välj domare i listan ovan.</div>`;
}

/* ==========================================================================
   TOPLIST
   ========================================================================== */
function buildToplist(matches) {
  const refCounts = {};

  matches.forEach(m => {
    if (m.Referee1) refCounts[m.Referee1] = (refCounts[m.Referee1] || 0) + 1;
    if (m.Referee2) refCounts[m.Referee2] = (refCounts[m.Referee2] || 0) + 1;
  });

  const sorted = Object.entries(refCounts).sort((a, b) => b[1] - a[1]);

  const root = document.getElementById("toplist");
  root.innerHTML = `
    <h2 class="text-lg font-semibold mb-1">Topplista (antal matcher per domare)</h2>
    <div class="bg-white rounded-xl shadow p-3 max-h-80 overflow-y-auto space-y-2" id="toplistBox"></div>
  `;

  const box = document.getElementById("toplistBox");

  sorted.forEach(([ref, count], index) => {
    const row = document.createElement("div");
    row.className = "flex justify-between text-sm";

    row.innerHTML = `
      <span>${index + 1}. ${ref}</span>
      <span class="font-semibold">${count}</span>
    `;

    box.appendChild(row);
  });
}

/* ==========================================================================
   REFEREE FILTER
   ========================================================================== */
function populateRefereeFilter(matches) {
  const refs = new Set();
  const select = document.getElementById("refereeFilter");
  select.innerHTML = `<option value="">Välj domare...</option>`;

  matches.forEach(m => {
    if (m.Referee1) refs.add(m.Referee1);
    if (m.Referee2) refs.add(m.Referee2);
  });

  [...refs].sort().forEach(ref => {
    const opt = document.createElement("option");
    opt.value = ref;
    opt.textContent = ref;
    select.appendChild(opt);
  });
}

function filterMatches() {
  const selected = document.getElementById("refereeFilter").value;

  if (!selected) {
    document.getElementById("content").innerHTML =
      `<div class="text-center text-gray-500">Välj en domare för att visa matcher.</div>`;
    return;
  }

  const filtered = allMatches.filter(
    m => m.Referee1 === selected || m.Referee2 === selected
  );

  renderMatches(filtered);
}

/* ==========================================================================
   MATCH CARDS
   ========================================================================== */
function renderMatches(matches) {
  const root = document.getElementById("content");
  root.innerHTML = "";

  matches.forEach(m => {
    const d = new Date(m.MatchDateTime);
    const time =
      d.toLocaleDateString("sv-SE") + " • " +
      d.toLocaleTimeString("sv-SE", { hour: "2-digit", minute: "2-digit" });

    const card = document.createElement("div");
    card.className = "bg-white p-4 rounded-xl shadow";

    card.innerHTML = `
      <div class="text-xs text-gray-500 mb-1">${m.competitionName}</div>
      <div class="font-semibold">
        ${m.HomeTeam} ${m.GoalsHomeTeam ?? ""} –
        ${m.GoalsAwayTeam ?? ""} ${m.AwayTeam}
      </div>

      <div class="text-sm text-gray-600 mt-2">
        <div>${time}</div>
        <div>${m.Venue}</div>
      </div>

      <div class="border-t mt-3 pt-2 text-sm">
        <b>Domare</b>
        <div>${m.Referee1}</div>
        <div>${m.Referee2}</div>
      </div>
    `;

    root.appendChild(card);
  });
}

/* ==========================================================================
   INIT
   ========================================================================== */
document.getElementById("loadBtn").addEventListener("click", loadRange);
document.getElementById("refereeFilter").addEventListener("change", filterMatches);

</script>
</body>
</html>
